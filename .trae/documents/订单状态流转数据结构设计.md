# 订单状态流转定义数据结构设计与实施计划

## 需求分析

1. 设计一套数据结构，存储订单状态流转定义
2. 数据存储到数据库中一个json或text字段中，不拆分存储
3. 订单状态分为显示值label和真实值value，value为int 0-10
4. 状态之间有动作定义，如：新增 →[接单]→ 已接单 →[备货]→ 已备货 →[完成]→ 已完成
5. 数据结构要便于解析显示和编辑
6. 不保存到settings字段，而是使用专门的OrderStatusFlow字段

## 数据结构设计

### 核心数据结构

```json
{
  "statuses": [
    { "value": 0, "label": "新增", "color": "info" },
    { "value": 1, "label": "待处理", "color": "warning" },
    { "value": 2, "label": "已接单", "color": "primary" },
    { "value": 3, "label": "已备货", "color": "success" },
    { "value": 10, "label": "已完成", "color": "success" }
  ],
  "transitions": [
    { "from": 0, "to": 1, "action": "接单" },
    { "from": 1, "to": 2, "action": "处理" },
    { "from": 2, "to": 3, "action": "备货" },
    { "from": 3, "to": 10, "action": "完成" }
  ]
}
```

### 数据结构说明

1. **statuses**：存储所有可能的订单状态
   - `value`：真实值，int类型，0-10
   - `label`：显示值，字符串类型
   - `color`：状态对应的颜色，用于前端展示

2. **transitions**：存储状态之间的流转关系
   - `from`：起始状态的value
   - `to`：目标状态的value
   - `action`：触发流转的动作名称

## 实施步骤

### 第一步：创建订单状态流转工具类

1. **创建`src/utils/orderStatusFlow.js`文件**
   - 定义默认的订单状态流转数据
   - 提供获取状态文本、状态颜色、可用流转等方法
   - 提供数据验证和解析方法

### 第二步：修改后端API和数据库

1. **在shops表中添加OrderStatusFlow字段**
   - 类型为JSON或TEXT
   - 用于存储订单状态流转定义

2. **修改后端API**
   - 在获取店铺信息时返回OrderStatusFlow字段
   - 在创建和更新店铺时处理OrderStatusFlow字段

### 第三步：修改ShopForm组件

1. **在ShopForm组件中添加订单状态流转编辑功能**
   - 添加OrderStatusFlow字段到formData
   - 在模板中添加订单状态流转编辑区域
   - 添加JSON格式验证
   - 确保OrderStatusFlow字段被正确保存

### 第四步：修改订单相关组件

1. **在订单列表和详情组件中使用新的数据结构**
   - 使用orderStatusFlow工具类获取状态文本和颜色
   - 使用orderStatusFlow工具类获取可用的状态流转
   - 确保与现有代码的兼容性

### 第五步：测试和验证

1. 测试新增店铺功能，确保OrderStatusFlow字段被正确保存
2. 测试修改店铺功能，确保OrderStatusFlow字段被正确更新
3. 测试订单状态流转功能，确保状态流转符合定义
4. 测试前端展示，确保状态文本和颜色正确显示

## 技术要点

1. **数据结构设计**：采用嵌套JSON结构，便于解析和编辑
2. **工具类封装**：提供统一的方法获取状态信息和流转规则，便于维护
3. **兼容性处理**：确保与现有代码的兼容性，平滑过渡
4. **数据验证**：添加JSON格式验证，确保数据有效性
5. **默认值设置**：提供合理的默认值，确保新店铺自动获得订单状态流转定义

## 预期效果

1. 每个店铺可以自定义自己的订单状态流转定义
2. 订单状态流转定义存储在专门的OrderStatusFlow字段中
3. 前端可以根据订单状态流转定义动态展示状态和可用操作
4. 支持灵活的状态流转配置，满足不同店铺的需求
5. 数据结构便于解析和编辑，支持后续扩展

## 风险评估

1. **数据结构变更**：修改订单状态流转数据结构可能导致现有功能异常
   - 解决方案：保持与现有代码的兼容性，提供降级处理

2. **JSON格式错误**：用户可能输入错误的JSON格式，导致系统异常
   - 解决方案：添加JSON格式验证，确保只有正确的JSON才能被保存

3. **性能问题**：频繁解析JSON可能影响性能
   - 解决方案：在工具类中添加缓存机制，减少重复解析

4. **用户体验问题**：直接编辑JSON格式可能影响用户体验
   - 解决方案：后续版本中可以设计专门的UI界面用于编辑订单状态流转定义